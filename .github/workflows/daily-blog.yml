name: Daily Dev Blog

# Two responsibilities:
#   generate  — sweeps GitHub activity, calls Claude, commits the article to a
#               branch article/YYYY-MM-DD, and opens a draft PR for editorial review.
#   deploy    — lives in deploy-pages.yml; fires on push to main (PR merge).
#
# Required secrets:
#   ANTHROPIC_API_KEY   — Claude API key
#   GH_PAT              — PAT with read access to all ojfbot repos (private + public)

on:
  schedule:
    - cron: '0 9 * * *'    # 09:00 UTC daily
  workflow_dispatch:
    inputs:
      date_override:
        description: 'Generate for this date (YYYY-MM-DD). Defaults to today UTC.'
        required: false
        type: string
      dry_run:
        description: 'Print article to logs without writing, committing, or opening a PR.'
        required: false
        type: boolean
        default: false

concurrency:
  group: daily-blog
  cancel-in-progress: false

jobs:
  generate:
    name: Generate & open draft PR
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      issues: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.15.4 --activate

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Run unit tests
        run: pnpm test

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate article
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # GH_PAT has read access to all private ojfbot repos for the sweep.
          GH_TOKEN: ${{ secrets.GH_PAT }}
          OJFBOT_ORG: ojfbot
          DATE_OVERRIDE: ${{ github.event.inputs.date_override }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: pnpm generate

      - name: Upload article artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: article-${{ github.run_number }}
          path: _articles/
          retention-days: 90
          if-no-files-found: ignore

      # ── Branch + commit ─────────────────────────────────────────────────────
      # Creates branch article/YYYY-MM-DD, commits the article, pushes.
      # Emits step outputs `date` and `branch` consumed by the PR step.
      # Exits cleanly (empty outputs) if: dry_run, branch exists, or no changes.

      - name: Create branch and commit article
        if: github.event.inputs.dry_run != 'true'
        id: commit
        run: |
          DATE="${{ github.event.inputs.date_override }}"
          DATE="${DATE:-$(date -u +%Y-%m-%d)}"
          DATE="${DATE:0:10}"
          BRANCH="article/${DATE}"

          git config user.name "ojfbot-blog[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code origin "${BRANCH}" > /dev/null 2>&1; then
            echo "::notice::Branch ${BRANCH} already exists — skipping."
            exit 0
          fi

          git checkout -b "${BRANCH}"
          git add _articles/

          if git diff --staged --quiet; then
            echo "::notice::No article changes staged."
            exit 0
          fi

          git commit -m "blog: ${DATE} [skip ci]"
          git push -u origin "${BRANCH}"

          echo "date=${DATE}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"

      # ── Draft PR ────────────────────────────────────────────────────────────
      # Opens a structured draft PR using the article frontmatter.
      # PR body is built by .github/scripts/build_pr_body.py (avoids YAML/heredoc issues).
      # Uses GH_PAT — GITHUB_TOKEN cannot create PRs without org-level settings.
      # Only runs when the commit step actually pushed a new branch.

      - name: Open draft PR
        if: steps.commit.outputs.date != ''
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          DATE="${{ steps.commit.outputs.date }}"
          BRANCH="${{ steps.commit.outputs.branch }}"

          python3 .github/scripts/build_pr_body.py \
            "${DATE}" "${BRANCH}" "_articles/${DATE}.md" \
            > /tmp/pr-body.md

          gh pr create \
            --draft \
            --title "blog: ${DATE}" \
            --body-file /tmp/pr-body.md \
            --base main \
            --head "${BRANCH}"
