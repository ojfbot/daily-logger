name: Daily Dev Blog

# Two jobs:
#   generate  — sweeps GitHub activity, calls Claude, commits articles/YYYY-MM-DD.md
#   pages     — builds Jekyll site and deploys to GitHub Pages
#
# Required secrets:
#   ANTHROPIC_API_KEY   — Claude API key
#   GITHUB_TOKEN        — auto-provided; use a PAT for private ojfbot repos
#
# Enable GitHub Pages in repo Settings → Pages → Source: GitHub Actions

on:
  schedule:
    - cron: '0 9 * * *'    # 09:00 UTC daily
  workflow_dispatch:
    inputs:
      date_override:
        description: 'Generate for this date (YYYY-MM-DD). Defaults to today UTC.'
        required: false
        type: string
      dry_run:
        description: 'Print article to logs without writing or committing.'
        required: false
        type: boolean
        default: false

concurrency:
  group: daily-blog
  cancel-in-progress: false

jobs:
  generate:
    name: Generate & commit article
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      issues: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        run: |
          corepack enable
          corepack prepare pnpm@9.15.4 --activate

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate article
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OJFBOT_ORG: ojfbot
          DATE_OVERRIDE: ${{ github.event.inputs.date_override }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: pnpm generate

      - name: Upload article artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: article-${{ github.run_number }}
          path: articles/
          retention-days: 90
          if-no-files-found: ignore

      - name: Commit and push article
        if: github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "ojfbot-blog[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add articles/
          if git diff --staged --quiet; then
            echo "No changes — article already exists for this date."
            exit 0
          fi
          DATE="${{ github.event.inputs.date_override }}"
          DATE="${DATE:-$(date -u +%Y-%m-%d)}"
          git commit -m "blog: ${DATE} [skip ci]"
          git pull --rebase origin ${{ github.ref_name }} \
            && git push \
            || echo "::warning::Push failed — article saved as artifact above."

  pages:
    name: Deploy to GitHub Pages
    needs: generate
    # Run on every push to main (including the article commit) and on manual dispatch.
    # Skipped during dry runs since no new article is committed.
    if: |
      always() &&
      github.event.inputs.dry_run != 'true' &&
      (needs.generate.result == 'success' || needs.generate.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Pull latest so we have the article just committed by generate job
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Setup Ruby (Jekyll)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install Jekyll
        run: gem install jekyll bundler

      - name: Build Jekyll site
        run: jekyll build --destination _site
        env:
          JEKYLL_ENV: production

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site/

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4
